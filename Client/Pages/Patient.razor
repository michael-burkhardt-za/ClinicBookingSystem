@page "/patient/create"
@page "/patient/edit/{Id:int}"
@inject ISnackbar Snackbar

@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Nav

<MudPaper Class="pa-6 mx-auto" MaxWidth="600px" Elevation="3">

    <MudText Typo="Typo.h5" Class="mb-4">
        @(IsEditMode ? "Edit Patient" : "Create Patient")
    </MudText>

    <MudForm @ref="_form" Model="_patient" OnValidSubmit="SavePatient">

        <MudTextField Label="Patient Name"
                      @bind-Value="_patient.FirstName"
                      For="@(() => _patient.FirstName)"
                      Required="true" />

        <MudTextField Label="Patient Surname"
                      @bind-Value="_patient.LastName"
                      For="@(() => _patient.LastName)"
                      Required="true" />

        <MudTextField Label="Email"
                      @bind-Value="_patient.Email"
                      For="@(() => _patient.Email)"
                      Required="true" />

        <MudDivider Class="my-4" />

        <MudStack Row="true" Spacing="2">
          
            <MudButton OnClick="SavePatient"
                       Variant="Variant.Filled"
                       Color="Color.Primary">
                Save
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       OnClick="Cancel">
                Cancel
            </MudButton>
        </MudStack>

    </MudForm>
</MudPaper>

@code {
    [Parameter] public int? Id { get; set; }

    private MudForm _form = default!;
    private PatientDto _patient = new();
    private bool IsEditMode => Id.HasValue;

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            var patient = await Http.GetFromJsonAsync<PatientDto>($"patients/{Id}");
            if (patient is not null)
                _patient = patient;
        }
    }

    private async Task SavePatient()
    {
        await _form.Validate();

        if (!_form.IsValid)
            return;

        if (IsEditMode)
        {
            await Http.PutAsJsonAsync("patients", _patient);
            Snackbar.Add("patient updated successfully", Severity.Success);
            
        }
        else
        {
            await Http.PostAsJsonAsync("patients", _patient);
            Snackbar.Add("patient created successfully", Severity.Success);
        }

        Nav.NavigateTo("/patients");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/patients");
    }
}