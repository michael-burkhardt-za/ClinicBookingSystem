@page "/booking"
@inject HttpClient Http
@inject IAppointmentApiService AppointmentService
@inject IClinicApiService ClinicApiService
@inject IPatientApiService PatientApiService

@inject ISnackbar Snackbar



<MudPaper Class="pa-4" Elevation="2">

    <MudText Typo="Typo.h5" Class="mb-4">
        Book Appointment
    </MudText>

    <MudSelect T="ClinicDto" Label="Select Clinic" @bind-Value="_selectedClinic">
        @foreach (var clinic in _clinics)
        {
            <MudSelectItem Value="@clinic">@clinic.Name</MudSelectItem>
        }
    </MudSelect>
    <MudSelect T="PatientDto" Label="Select Patient" @bind-Value="_selectedPatient">
        @foreach (var patient in _patients)
        {
            <MudSelectItem Value="@patient">@patient.LastName</MudSelectItem>
        }
    </MudSelect>

    <MudGrid>

        <!-- Date Picker -->
        <MudItem xs="12" sm="6">
            <MudDatePicker Label="Select Date"
            @bind-Date="SelectedDate"
            DisableToolbar="true"
            MinDate="@DateTime.Today" />
        </MudItem>

        <!-- Time Slots -->
        <MudItem xs="12" sm="6">
            <MudSelect T="DateTime?"
            Label="Available Time Slots"
            @bind-Value="_selectedSlot"
            Disabled="@(!_slots.Any())">

                @foreach (var slot in _slots)
                {
                    <MudSelectItem Value="@slot">
                        @slot?.ToString("HH:mm")
                    </MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <!-- Book Button -->
        <MudItem xs="12">
            <MudButton Variant="Variant.Filled"
            Color="Color.Primary"
            Disabled="@(!_canBook)"
            OnClick="BookAppointment">

                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small"
                    Indeterminate="true"
                    Class="mr-2" />
                }

                Book Appointment
            </MudButton>
        </MudItem>

    </MudGrid>

</MudPaper>

@code {

    private DateTime? _selectedDate;

    private DateTime? SelectedDate
    {
        get => _selectedDate;
        set
        {
            if (_selectedDate != value)
            {
                _selectedDate = value;
                _ = LoadSlotsAsync(value);   // fire async method safely
            }
        }
    }
    private List<DateTime?> _slots = new();
    private DateTime? _selectedSlot;

    private ClinicDto? _selectedClinic;
    private PatientDto? _selectedPatient;
    private List<ClinicDto> _clinics = new();
    private List<PatientDto> _patients = new();

    // Hardcoded for demo
    private int _clinicId;
    private int _patientId;

    private bool _isLoading = false;
    private bool _canBook =>
        _selectedDate.HasValue &&
        _selectedSlot.HasValue &&
        !_isLoading;

    protected override async Task OnInitializedAsync()
    {
        await LoadClinics();
        await LoadPatients();
    }

    private async Task LoadClinics()
    {
        try
        {
            _isLoading = true;
            _clinics = (await ClinicApiService.GetClinics()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error loading clinics", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task BookAppointment()
    {
        if (!_selectedSlot.HasValue) return;

        _isLoading = true;

        var appointment = new AppointmentBookingDto
        {
            ClinicId = _selectedClinic.Id,
            PatientId = _selectedPatient.Id,
            AppointmentDate = _selectedSlot.Value
        };

        var id = await AppointmentService.BookAppointment(appointment);

        if (id > 0)
        {

            Snackbar.Add("Appointment booked successfully!",
                    Severity.Success);
        }
        else
        {

            Snackbar.Add("Failed to book appointment!",
                     Severity.Error);
        }

        // Reset selection
        _selectedSlot = null;
        _slots.Clear();

        _isLoading = false;
        StateHasChanged();


    }

    private async Task LoadSlotsAsync(DateTime? date)
    {
        _selectedSlot = null;
        _slots.Clear();

        if (!date.HasValue)
            return;

        try
        {
            _isLoading = true;

            var results = await AppointmentService
                                .GetAvailableSlots(_selectedClinic.Id, date.Value);

            _slots = results
                .Select(x => (DateTime?)x)
                .OrderBy(x => x)
                .ToList();

            if (!_slots.Any())
                Snackbar.Add("No available slots.", Severity.Warning);
        }
        catch
        {
            Snackbar.Add("Failed to load slots.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPatients()
    { 
        try
        {
            _isLoading = true;
            _patients = (await PatientApiService.GetPatients()).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading patients: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    
    
    }


    
}

   